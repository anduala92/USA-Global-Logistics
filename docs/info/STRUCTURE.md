# Структура и обяснение на проекта USA Global Logistics API

## Основни слоеве и отговорности

- **Program.cs** — главен файл, стартиращ приложението, дефинира зависимостите и всички крайни точки (API endpoints).
    - Установява връзка с базата, JWT настройки, CORS и регистрация на услуги.
    - Дефинира всички API за CRUD операции по клиенти, поръчки, превозвачи, шофьори, превозни средства, локации и пратки.
    - Организира моделите и DTO-моделите (data transfer objects).

- **Models/** — модели на бизнес обектите (ентитита, всички таблици в базата данни).
    - `Entities.cs`: Съдържа класове за User, Customer, Order, Carrier, Driver, Vehicle, VehicleModel, Location, Shipment, ShipmentVehicle, ShipmentDriver.
    - `Auth.cs`: Модели, свързани с потребители и JWT (RefreshToken и др.).
    - `Enums.cs`: Всички изброими типове (UserRole, ShipmentStatus, DriverRole и др.).

- **Data/** — конфигурации за базата данни (Обикновено AppDbContext.cs и миграции).
    - Обработва връзката с SQLite и всички ентитита.

- **Dto/** — DTO (Data Transfer Object) модели за вход/изход. Абстрахират бизнес логиката от трансфера на данни към UI.
    - `DtoModels.cs`: DTO класове за клиенти, поръчки, превозни средства, шофьори и т.н.

- **Services/** — бизнес логика и помощни класове.
    - `JwtTokenHelper.cs`: Генерира, валидира и ротация на JWT токени.
    - `Orchestrator.cs`: Абстрахира основните операции (чете, записва, изтрива комплексно обекти с връзки), често агрегира логика, която иначе би отишла във всеки Endpoint.

## Кратко описание на основните класове

- **User** — Потребител на системата (role: Admin|Dispatcher|Driver).
- **Customer** — Клиент, който поръчва логистична услуга.
- **Order** — Заявка/поръчка от клиент.
- **Carrier** — Фирма-превозвач.
- **Driver** — Шофьор, служител на превозвач.
- **VehicleModel & Vehicle** — Модел на МПС и самото МПС (VIN и др.).
- **Location** — Локация (адрес, гео-координати).
- **Shipment** — Конкретна пратка с връзки към order, pickup и delivery location.
- **ShipmentVehicle, ShipmentDriver** — Линк таблици за M:N връзки (една пратка с много превозни средства/шофьори).

## Как да проследиш бизнес логиката

1. **Endpoints** се дефинират в Program.cs. CRUD е базов, за по-комплексни операции се ползват Orchestrator и DTO endpoint-и.
2. **Orchestrator.cs** агрегира логика и свързани действия — примерно създаване на пратка заедно с всички включени превозни средства/шофьори.
3. **JwtTokenHelper.cs** — handle-ва цялата логика по автентикация и refresh на сесии.
4. **AppDbContext.cs** (в Data/) — дефинира и конфигурира връзката с базата и всички таблици.
5. **UI/Frontend** (в отделна папка/projekt) работи основно с /ui/ endpoint-и от бекенда.

## Допълнително:
- Всички endpoints с /ui/ използват DTO класове и са оптимизирани за работа с UI.
- Влизането, регистрация, токени — преминават през /auth/ endpoint-и, бизнес логика за ролеви достъп стои на ниво claims във JWT.
- Seed-ване на демо данни — `/ui/seed` (само с JWT).

## Как най-бързо да се ориентираш:
1. Прегледай ERD и STRUCTURE.md.
2. Разгледай Program.cs – тук е „map“ на цялото API.
3. Разгледай моделите в Models/ и Dto/.
4. Ако имаш казус за бизнес логика – виж Orchestrator.cs и Services/.
5. Ползвай Postman с USAGL.postman_collection.json или UI-то за експерименти.

---
За въпроси – чети README/STRUCTURE.md и после разглеждай по-depth конкретните класове в Models/ и Services/.