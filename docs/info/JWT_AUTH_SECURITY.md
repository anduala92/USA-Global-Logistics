# Обяснение: JWT, Security и аутентикация в USA Global Logistics API

## Какво е JWT (JSON Web Token)
- **JWT** (JSON Web Token) е стандартизиран начин за сигурно предаване на удостоверена информация между потребител и сървър.
- Съдържа 3 части: заглавна част (header), съдържание (payload — напр. id, role), и подпис (signature), който гарантира автентичността.

---
## Процес на аутентикация и сесии

1. **Регистрация на потребител** (`POST /auth/register`)
   - Потребителят подава e-mail, парола, роля.
   - Паролата се хешира с BCrypt и се съхранява само като hash.
2. **Логин** (`POST /auth/login`)
   - Подава се e-mail и парола.
   - Паролата се сравнява чрез BCrypt с хеша в БД.
   - Ако е вярна, се генерира:
     - **Access Token** (JWT, валиден ~60 мин)
     - **Refresh Token** (дълъг низ, валиден по-дълго)
   - JWT се издава с роля, id и други claims, подписан със secret ключ.
3. Клиентът пази access token-а в памет (memory) и го подава като `Bearer` header при всяка заявка.
4. При изтичане на access token (или изричен logout), клиентът подава refresh token (`POST /auth/refresh`), за да получи нови токени — предният се отбелязва като revoked.

---
## Как работи Security и Authorization
- **Всички endpoints** изискват валиден JWT Access Token чрез header (освен /auth/* и /health).
- **JWT**-то съдържа информация за потребителя (Id, роля и др.), която се използва за достъп (authorization) на определени операции.
- Role-based достъпа се управлява от claim „role“ в JWT.
- Допълнително — специални политики и проверки чрез middleware.
- В DEV режима някои проверки са отпуснати за по-лесно тестване (виж ValidateIssuer, ValidateLifetime).

---
## Refresh Token механизъм
- Освен JWT, има и Refresh Token — пази се отделно в БД и винаги се инвалидира при ротация (повишава сигурността).
- Ако Refresh Token бъде зловредно използван — достъпът се прекъсва автоматично.

---
## Сигурност:
- **BCrypt** — доказан стандарт за хеширане на пароли.
- **JWT Secret Key** — дълъг, случаен и се пази само на бекенда.
- **CORS** — позволява само заявки от whitelist-нат адрес (в dev: http://localhost:5173)
- **HTTPS** – само през сигурна връзка.
- **Ролите** (claims) позволяват granular-достъп до ресурси (пример: само Admin може да seed-не база).

---
## Какво да запомня:
- Без JWT — няма достъп до нищо (освен анонимните endpoints: login, register, healthcheck).
- Подписът на токените гарантира, че няма подмяна.
- Всеки refresh е еднократен — не може да се използва повторно.
- Проверки: валиден подпис, роли, дата на изтичане, статус в БД.

---
За повече — прегледай:
- Services/JwtTokenHelper.cs (логика за токените)
- Program.cs (конфигурация на middleware и Auth)
- Models/Auth.cs (RefreshToken)
- Документация тук в JWT_AUTH_SECURITY.md